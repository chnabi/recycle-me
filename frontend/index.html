<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recycle Me</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body onload="getlocation()">
    <div class="header">
        <h1>Recycle Me</h1>
        <p class="description">Recycle Me is an interactive tool designed to help users determine whether an item is recyclable. Using your device's camera, simply scan the item, and our system will analyze it. Within seconds, you'll receive a result indicating whether it can be recycled, helping you make environmentally conscious decisions and reduce waste effectively.</p>
    </div>

    <div class="container">
        <div class="instructions">
            <h2>Instructions</h2>
            <ul>
                <li class="step active">Step 1: Place the item in front of the camera.</li>
                <li class="step">Step 2: Click "Scan Me" to capture an image.</li>
                <li class="step">Step 3: Wait for analysis.</li>
                <li class="step">Step 4: Check the result below the image.</li>
            </ul>
        </div>

        <div class="camera-box">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <button id="scanButton">Scan Me</button>
            <p id="resultText">This is ...</p>
            <p id="resultEmoji"></p>
        </div>

        <div class="info-box">
            <h2>Information about the Item</h2>
            <p id="itemInfo">Item details will appear after analysis.</p>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const scanButton = document.getElementById('scanButton');
        const resultText = document.getElementById('resultText');
        const resultEmoji = document.getElementById('resultEmoji');
        const itemInfo = document.getElementById('itemInfo');
        const steps = document.querySelectorAll('.step');
        

        let scanning = true;
        const myAPIKey = "d8461e0e6a1c427e8b73336d3e77a241";
        var resb64 ="";
        let lat; 
        let long;
        let city = "";
        let county = "";

        // get users current position
        function getlocation() {
            navigator.geolocation.getCurrentPosition(showLoc);
        }
        function showLoc(pos) {             
            lat = pos.coords.latitude;
            long = pos.coords.longitude;
            console.log(lat + " " + long);

            getCityFromCoords(lat, long, myAPIKey)
                .then(({city: fetchedCity, county: fetchedCounty}) => {
                    console.log(fetchedCity);
                    console.log(fetchedCounty);
                    city = fetchedCity;
                    county = fetchedCounty;
                })
                .catch(error => console.error(error));
        }

        //convert users position to recycling district

        async function getCityFromCoords(latitude, longitude, apiKey) {
            const url = `https://api.geoapify.com/v1/geocode/reverse?lat=${latitude}&lon=${longitude}&apiKey=${apiKey}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.features && data.features.length > 0) {

                    let properties = data.features[0].properties;
                    let city = properties.city;
                    let county = properties.county;

                    return {city, county};
                } else {
                    return "Location not found";
                }
            } catch (error) {
                console.error("Error fetching location data:", error);
                return "Error fetching data";
            }
        }
        
        //start video feed
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(error => console.error('Error accessing camera:', error));
        

        //allow user to take photo
        scanButton.addEventListener('click', () => {
            if (scanning) {
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth/3;
                canvas.height = video.videoHeight/3;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                canvas.toBlob((blob) => {
                        if (!blob) return;

                        const formData = new FormData();
                        formData.append("file", blob, "captured_image.png");
                        formData.append("lat", lat);
                        formData.append("long", long);
                        formData.append("city", city);
                        formData.append("county", county);
                        console.log(formData.get("file"));
                        console.log(formData.get("lat"));
                        console.log(formData.get("long"));
                        console.log(formData.get("city"));
                        console.log(formData.get("county"));
                        fetch("http://127.0.0.1:8000/inform", {
                            method: "POST",
                            mode: "cors",
                            body: formData,
                        })
                        .then((response) => response.json())
                        .then((json) => console.log(json))
                        .catch((error) => console.error("Upload failed:", error));

                    }, "image/png", 0.7); // PNG with 50% quality
                

                canvas.style.display = 'block';
                video.style.display = 'none';

                console.log(county, city, "plastic", lat, long);

                scanButton.textContent = 'Scan Again';
                scanning = false;
                console.log("Scanning state changed to:", scanning);
                console.log("Base 64 Encoded Image:", resb64);

                updateSteps(2);

                setTimeout(() => {
                    const results = ['‚úÖ', '‚ùå', 'üßê'];
                    const itemDetails = [
                        "Plastic Bottle - This item is recyclable. Please rinse it before disposal.",
                        "Paper Cup - This item is NOT recyclable due to the wax coating.",
                        "Aluminum Can - 100% recyclable. Ensure it's empty before recycling."
                    ];
                    const randomIndex = Math.floor(Math.random() * results.length);
                    
                    resultText.innerHTML = `This is ...`;
                    resultEmoji.innerHTML = `<span class="big-emoji">${results[randomIndex]}</span>`;
                    itemInfo.innerHTML = itemDetails[randomIndex];

                    updateSteps(3);
                }, 2000);
            } else {
                canvas.style.display = 'none';
                video.style.display = 'block';
                scanButton.textContent = 'Scan Me';
                resultText.innerHTML = "This is ...";
                resultEmoji.innerHTML = "";
                itemInfo.innerHTML = "Item details will appear here after analysis.";
                
                scanning = true;
                console.log("Scanning state changed to:", scanning);

                updateSteps(0);
            }
        });

        //increment through instructions
        function updateSteps(currentStep) {
            steps.forEach((step, index) => {
                step.classList.remove('active');
                if (index === currentStep) {
                    step.classList.add('active');
                } 
            });
        }
    </script>
</body>
</html>